/* ========================================
   LAYER 4: GLASS COMPONENT
   Premium Glass Effect Styles
   Depth-Aware Rendering System v2.0
   ======================================== */

.liquidGlass-wrapper {
  /* 1. 深度变量初始化 (如果未提供，默认为 0) */
  --local-depth: 0;
  
  position: relative;
  display: flex;
  overflow: hidden;
  isolation: isolate;
  /* [Refactor] 使用 Tokenized Radius */
  border-radius: var(--radius-xl);
  
  /* [性能优化] 强制提升为合成层 (Compositor Layer) */
  /* 这会让浏览器将此元素及其模糊效果缓存为纹理，避免每帧重绘 */
  transform: translateZ(0);
  
  /* [性能优化] 告诉浏览器此元素的绘制不会影响外部 */
  /* 使用更保守的 contain 值，避免影响某些 CSS 属性的继承 */
  contain: layout paint;
  
  /* [性能优化] 显式声明合成层，帮助浏览器进行内存管理 */
  /* 只在需要时使用 will-change，避免滥用导致不必要的内存分配 */
  will-change: transform, backdrop-filter;
  
  /* --- [核心优化] 动态模糊计算 --- */
  /* 深度越深，模糊越小（因为背景已经被上层模糊过了，没必要浪费 GPU） */
  /* 使用 clamp() 替代 max()，兼容性更好，防止模糊度变成负数 */
  --dynamic-blur: clamp(0px, calc(var(--glass-blur-base) - (var(--local-depth) * var(--glass-blur-decay))), var(--glass-blur-base));
  
  /* 动态模糊值（现代浏览器支持 CSS 变量在 backdrop-filter 中使用） */
  /* 如果浏览器不支持，会回退到基础值 12px（通过 JavaScript 动态注入） */
  backdrop-filter: blur(var(--dynamic-blur)) saturate(var(--saturation));
  -webkit-backdrop-filter: blur(var(--dynamic-blur)) saturate(var(--saturation));
  
  /* --- [核心优化] 动态不透明度计算 --- */
  /* 深度越深，越不透明，增加层级感 */
  --dynamic-opacity: calc(var(--glass-opacity-base) + (var(--local-depth) * var(--glass-opacity-increment)));
  
  background-color: color-mix(in oklch, var(--c-glass) calc(var(--dynamic-opacity) * 100%), transparent);
  
  /* --- 阴影优化 (保持原有的精美设计，但可以微调强度) --- */
  /* 随着深度增加，阴影可以稍微加重，增强立体感 */
  /* 高光和阴影使用主题的 --c-light 和 --c-dark，确保与主题色彩同步 */
  /* 提高透明度乘数，让主题色彩（特别是 dim 主题的霓虹效果）更明显 */
  box-shadow: 
    /* 内边缘高光 - 使用主题的高光色，提高透明度让主题色彩更明显 */
    inset 0 0 0 1.5px color-mix(in oklch, var(--c-light) calc(var(--glass-reflex-light) * 30%), transparent),
    inset 1.8px 3px 0px -2px color-mix(in oklch, var(--c-light) calc(var(--glass-reflex-light) * 85%), transparent), 
    inset -2px -2px 0px -2px color-mix(in oklch, var(--c-light) calc(var(--glass-reflex-light) * 75%), transparent), 
    inset -3px -8px 1px -6px color-mix(in oklch, var(--c-light) calc(var(--glass-reflex-light) * 55%), transparent), 
    /* 内边缘阴影 - 使用主题的阴影色，提高透明度让主题色彩更明显 */
    inset -0.3px -1px 4px 0px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 15%), transparent),
    inset -1.5px 2.5px 0px -2px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 25%), transparent), 
    inset 0px 3px 4px -2px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 25%), transparent), 
    inset 2px -6.5px 1px -4px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 15%), transparent), 
    /* 外阴影 - 使用主题的阴影色 */
    0px 1px 5px 0px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 15%), transparent), 
    0px 6px 16px 0px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * (10% + var(--local-depth) * 1%)), transparent);
  
  /* 平滑过渡，避免视觉跳跃 */
  /* [Refactor] 使用标准过渡时间 Token */
  transition: background-color var(--transition-fast) var(--ease-glass),
              backdrop-filter var(--transition-fast) var(--ease-glass),
              box-shadow var(--transition-fast) var(--ease-glass);
}

/* --- 性能模式 (Animation Mode) --- */
/* 当 isAnimated=true 或 isAnimating=true 时激活 */
.liquidGlass-wrapper.performance-mode {
  /* 在动画期间禁用模糊！这是 60fps 的关键 */
  /* 模糊是 GPU 最昂贵的操作之一，尤其是大面积模糊 */
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  
  /* 作为补偿，增加不透明度，避免看起来太透 */
  background-color: color-mix(in oklch, var(--c-glass) 80%, transparent);
  
  /* 移除昂贵的阴影计算 */
  box-shadow: none;
  border: 1px solid color-mix(in oklch, var(--c-glass) 30%, transparent);
  
  /* 只在动画模式下使用 will-change，避免滥用 */
  will-change: transform, opacity;
}

.liquidGlass-content {
  position: relative;
  z-index: var(--z-content);
  width: 100%;
}

/* 当 wrapper 是 flex 容器时，content 也应该支持 flex 布局 */
.liquidGlass-wrapper.flex .liquidGlass-content,
.liquidGlass-wrapper.flex-col .liquidGlass-content {
  display: flex;
  height: 100%;
}

.liquidGlass-wrapper.flex-col .liquidGlass-content {
  flex-direction: column;
}

/* SVG Filter for Glass Distortion */
.glass-filter {
  position: absolute;
  width: 0;
  height: 0;
  z-index: -1;
}

/* --- [性能优化] 条件性 Mask 应用 --- */
/* 
 * mask-image 是浏览器中渲染成本最高的操作之一，会强制分配显存极大的离屏缓冲区
 * 现代浏览器的 border-radius + overflow: hidden 在大多数合成层场景下已修复溢出问题
 * 
 * 策略：默认不应用 mask-image，仅在确实需要时通过 .masked 类启用
 * 如果测试发现 Safari 上圆角溢出问题严重，可以在特定元素上添加 .masked 类
 */
.liquidGlass-wrapper.masked {
  /* 强制 GPU 按照 alpha 通道进行遮罩裁剪，修复 Safari/Chrome 的圆角溢出问题 */
  /* 当使用 backdrop-filter 和 transform 时，浏览器有时会忽略 overflow: hidden 对子元素的裁剪 */
  -webkit-mask-image: -webkit-radial-gradient(white, black);
  mask-image: radial-gradient(white, black);
}

/* ========================================
   SHADCN CARD COMPONENT - GLASS EFFECT INTEGRATION
   为 shadcn Card 组件添加主题化的玻璃高光和阴影
   ======================================== */

/* 覆盖 Tailwind 的 border 和 shadow-sm，使用主题化的玻璃效果 */
.rounded-lg.border.bg-card {
  /* 移除 Tailwind 的默认边框和阴影 */
  border: none !important;
  box-shadow: none !important;
  
  /* 应用主题化的玻璃高光和阴影 */
  box-shadow: 
    /* 内边缘高光 - 使用主题的高光色 */
    inset 0 0 0 1px color-mix(in oklch, var(--c-light) calc(var(--glass-reflex-light) * 30%), transparent),
    inset 1.8px 3px 0px -2px color-mix(in oklch, var(--c-light) calc(var(--glass-reflex-light) * 85%), transparent), 
    inset -2px -2px 0px -2px color-mix(in oklch, var(--c-light) calc(var(--glass-reflex-light) * 75%), transparent), 
    inset -3px -8px 1px -6px color-mix(in oklch, var(--c-light) calc(var(--glass-reflex-light) * 55%), transparent), 
    /* 内边缘阴影 - 使用主题的阴影色 */
    inset -0.3px -1px 4px 0px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 15%), transparent),
    inset -1.5px 2.5px 0px -2px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 25%), transparent), 
    inset 0px 3px 4px -2px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 25%), transparent), 
    inset 2px -6.5px 1px -4px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 15%), transparent), 
    /* 外阴影 - 使用主题的阴影色 */
    0px 1px 5px 0px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 15%), transparent), 
    0px 6px 16px 0px color-mix(in oklch, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent);
  
  /* 平滑过渡 */
  transition: box-shadow var(--transition-fast) var(--ease-glass);
}

