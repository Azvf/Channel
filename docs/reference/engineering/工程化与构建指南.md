# 工程化与构建指南

本文档涵盖项目构建、检查、代码生成及环境配置的完整工作流。

## 1. 核心工作流 (Workflow)

我们采用了 **"构建即检查" (Check-on-Build)** 的策略。

| 场景 | 命令 | 包含动作 |
| :--- | :--- | :--- |
| **日常开发** | `npm run dev` | 启动 Vite 开发服务器 (Watch Mode) |
| **提交代码前** | `npm run check` | TS类型检查 + ESLint + 架构依赖检查 + Token生成 |
| **生产构建** | `npm run build` | **自动执行所有检查** -> Vite 构建 -> 代码混淆 |
| **快速构建** | `npm run build:dev` | 跳过混淆，用于测试环境 |

> **注意**: 严禁在 CI/CD 中使用 `build:skip-checks`，该命令仅供调试构建脚本本身使用。

## 2. 架构守护系统

我们在构建阶段强制执行架构规范。任何违规都会导致构建失败。

### 2.1 检查项详情

1.  **TypeScript**: `npm run check:type` - 确保类型安全。

2.  **ESLint**: `npm run check:lint` - 代码风格与最佳实践。

3.  **Dependency Cruiser**: `npm run check:arch` - **核心架构防线**。

    * 确保 `core` 层不依赖 `react`。

    * 确保分层架构（Layered Architecture）不被穿透。

    * 配置文件: [`.dependency-cruiser.cjs`](../.dependency-cruiser.cjs)

### 2.2 自动代码生成 (Codegen)

为了减少样板代码和保证一致性，我们使用生成工具：

* **Design Tokens**: `npm run generate:tokens`

    * 源: [`src/design-tokens/tokens.ts`](../src/design-tokens/tokens.ts)

    * 产物: [`src/popup/styles/tokens.generated.css`](../src/popup/styles/tokens.generated.css)

* **Database Types**: `npm run gen:types`

    * 基于 Supabase Schema 自动生成 TS 类型。

    * 产物: [`src/shared/types/database.types.ts`](../src/shared/types/database.types.ts)

* **组件模板 (Plop)**: `npm run gen`

    * 交互式创建 Dumb/Smart 组件、Storybook 及测试文件。

## 3. 环境配置 (Setup)

### 3.1 Supabase 集成

项目依赖 Supabase 生成类型。你需要配置 Project ID：

**方式 A (推荐): .env 文件**

在项目根目录 `.env` 中配置 `VITE_SUPABASE_URL`，脚本会自动提取 ID。

```bash
VITE_SUPABASE_URL=https://your-project-id.supabase.co
```

**方式 B: 环境变量**

```bash
export SUPABASE_PROJECT_ID=your-project-id
```

**方式 C: 从 Supabase Dashboard 获取**

1. 访问 https://app.supabase.com
2. 选择你的项目
3. 进入 Settings > API
4. 从 Project URL 中提取项目 ID（子域名部分，20个字符）

> **⚠️ Warning**: 项目 ID 必须是 **20 个字符的字母数字字符串**（只包含小写字母和数字）。

### 3.2 Schema-Driven Development (SDD)

**核心原理**: Database Schema 是唯一的真理来源 (SSOT)。前端类型必须由数据库自动生成。

**工作流程**:

1. 数据库变更：在 Supabase Dashboard 修改表结构
2. 生成类型：运行 `npm run gen:types`
3. 类型检查：运行 `npm run type-check`，如果 Mapper 未更新，TypeScript 会报错
4. 更新 Mapper：根据新的数据库类型更新 `mapper.ts` 中的转换函数

**⚠️ 重要**: 所有数据库查询结果必须经过 Mapper 转换，UI 层严禁直接依赖 `database.types.ts`。

详见: [`src/infra/database/supabase/mapper.ts`](../src/infra/database/supabase/mapper.ts)

### 3.3 组件脚手架 (Plop.js)

**交互式生成组件**:

```bash
npm run gen
# 或
npm run gen:component
```

**流程**:
1. 输入组件名称（PascalCase，如 `GlassCard`）
2. 选择组件类型（Dumb 或 Smart）
3. 自动生成以下文件：
   - `src/popup/components/ComponentName.tsx` - 组件本体
   - `src/popup/components/ComponentName.stories.tsx` - Storybook
   - `tests/components/ComponentName.ct.spec.tsx` - 视觉回归测试

**组件类型说明**:
- **Dumb Component**: 只负责渲染，无状态逻辑，严禁包含 `useEffect` 或 API 请求
- **Smart Component**: 包含业务逻辑和状态管理，可以包含 `useEffect`、API 请求等

### 3.4 视觉回归测试 (Visual Regression)

针对玻璃态组件 (`GlassCard`) 的特殊渲染测试：

* **运行测试**: `npm run test:ct`

* **原理**: 使用 [`GlassTestBed`](../tests/components/fixtures/GlassTestBed.tsx) 在高频背景（棋盘格/噪点）下检测模糊效果。

* **背景模式**:
  - `checkerboard`（默认）：高对比度棋盘格，最敏感
  - `noise`：噪点纹理，用于检测更细微的模糊效果
  - `gradient`：渐变背景，用于检测模糊边缘效果

## 4. 检查失败时的处理

如果某个检查失败，构建会停止并显示错误信息。

**常见违规及修复**:
- Core 层导入了 React → 移除 React 依赖
- Service 层导入了 Popup 组件 → 使用依赖注入或接口隔离
- Core 层依赖了 Service 层 → 将依赖移到 Service 层或使用依赖注入
- Core 层依赖了 Chrome API → 使用抽象层或移到 infra 层
- 循环依赖 → 重构代码结构

运行 `npm run check:arch` 查看详细的依赖违规信息。

## 5. CI/CD 集成

在 CI/CD 流程中，建议在构建前运行检查：

```yaml
# GitHub Actions 示例
- name: Run architecture checks
  run: npm run check

- name: Build
  run: npm run build
```

或者直接使用 `npm run build`，因为它会自动执行 `prebuild` hook。

## 6. 最佳实践

1. **开发时**: 使用 `npm run dev` 快速迭代
2. **提交前**: 运行 `npm run check` 确保代码符合规范
3. **CI/CD**: 使用 `npm run build` 确保生产代码质量
4. **避免使用**: `npm run build:skip-checks`（除非调试构建问题）


