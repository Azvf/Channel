# 构建时架构检查说明

## 概述

项目已配置**自动架构检查**，在每次构建前会自动执行所有架构守护检查，确保代码符合规范。

## 自动执行的检查

当运行 `npm run build` 时，会自动执行以下检查（通过 `prebuild` hook）：

1. **TypeScript 类型检查** (`npm run type-check`)
   - 确保所有代码类型正确
   - 检查未使用的变量和参数

2. **ESLint 检查** (`npm run lint`)
   - 代码风格检查
   - **自定义规则**（待实现）：
     - `no-raw-z-index`: 禁止魔法数字 z-index
     - `require-optimistic-update`: 提醒实现乐观更新
   - 注意：自定义规则需要正确配置 ESLint 插件格式，目前暂时禁用

3. **依赖架构检查** (`npm run check:arch`)
   - 使用 `dependency-cruiser` 检查分层架构
   - 确保 Core 层不依赖 React/Chrome API
   - 确保 Service 层不依赖 UI 层
   - 禁止循环依赖

4. **Design Tokens 生成** (`npm run generate:tokens`)
   - 从 `src/design-tokens/tokens.ts` 生成 CSS 变量
   - 确保设计系统单一真理源

## 使用方法

### 正常构建（包含所有检查）

```bash
npm run build
```

这会自动执行所有架构检查，只有全部通过才会开始构建。

### 开发模式构建（跳过检查）

如果需要在开发时快速构建，可以使用：

```bash
npm run build:dev
```

或者完全跳过检查：

```bash
npm run build:skip-checks
```

> **注意**: 生产构建 (`npm run build:prod`) 会执行所有检查，确保生产代码质量。

### 手动运行检查

如果需要单独运行某个检查：

```bash
# TypeScript 类型检查
npm run type-check

# ESLint 检查
npm run lint

# 依赖架构检查
npm run check:arch

# 生成 Design Tokens
npm run generate:tokens

# 运行所有预构建检查
npm run prebuild:checks
```

## 检查失败时的处理

如果某个检查失败，构建会停止并显示错误信息。运行 `npm run check:arch` 查看详细的依赖违规信息。

常见违规及修复：
- Core 层导入了 React → 移除 React 依赖
- Service 层导入了 Popup 组件 → 使用依赖注入或接口隔离
- Core 层依赖了 Service 层 → 将依赖移到 Service 层或使用依赖注入
- Core 层依赖了 Chrome API → 使用抽象层或移到 infra 层
- 循环依赖 → 重构代码结构

## CI/CD 集成

在 CI/CD 流程中，建议在构建前运行检查：

```yaml
# GitHub Actions 示例
- name: Run architecture checks
  run: npm run prebuild:checks

- name: Build
  run: npm run build
```

或者直接使用 `npm run build`，因为它会自动执行 `prebuild` hook。

## 依赖安装

运行 `npm install` 安装所有依赖（包括 `dependency-cruiser`）。

## 配置说明

### 预构建检查脚本

位置: `scripts/bin/pre-build-checks.js`

可以自定义检查项和错误处理逻辑。

### 架构规则配置

位置: `.dependency-cruiser.cjs`

可以添加或修改依赖规则。注意：由于项目使用 ES 模块（`"type": "module"`），配置文件使用 `.cjs` 扩展名以支持 CommonJS 语法。

### ESLint 规则

位置: `eslint-rules/`

可以添加新的自定义规则。

## 最佳实践

1. **开发时**: 使用 `npm run build:dev` 快速迭代
2. **提交前**: 运行 `npm run prebuild:checks` 确保代码符合规范
3. **CI/CD**: 使用 `npm run build` 确保生产代码质量
4. **紧急情况**: 使用 `npm run build:skip-checks` 临时跳过检查（不推荐）

## 总结

通过自动架构检查，我们实现了：

- ✅ **规则强制执行**: 违反架构规则的代码无法构建
- ✅ **早期发现问题**: 在构建前就发现类型错误和架构违规
- ✅ **代码质量保证**: 确保生产代码符合所有规范
- ✅ **降低维护成本**: 自动化检查，无需人工审查

这样，架构规范不再是"建议"，而是**强制要求**。

