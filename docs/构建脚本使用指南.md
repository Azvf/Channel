# 构建脚本使用指南

本文档说明项目中的构建脚本组织和使用方法。

---

## 脚本架构

### 核心原则

**所有构建操作自动包含检查**。运行 `build` 相关命令时，会自动执行所有必要的检查，无需单独运行。

---

## 构建工作流

### 基础构建命令

#### `npm run build`
**完整构建流程**（推荐用于生产环境）
- ✅ 自动运行所有检查（通过 `prebuild` hook）
  - TypeScript 类型检查
  - ESLint 检查
  - 依赖架构检查
  - Design Tokens 生成
- ✅ 执行 Vite 构建

**使用场景**：生产构建、CI/CD 流程

#### `npm run build:dev`
**开发环境构建**
- ✅ 自动运行所有检查
- ✅ 执行 Vite 构建（development 模式）

**使用场景**：开发环境构建

#### `npm run build:prod`
**生产环境完整构建**
- ✅ 自动运行所有检查
- ✅ 执行 Vite 构建
- ✅ 代码混淆（obfuscate）

**使用场景**：最终发布版本

#### `npm run build:skip-checks`
**跳过检查的快速构建**（不推荐）
- ⚠️ 仅执行 TypeScript 编译检查（`tsc`）
- ⚠️ 执行 Vite 构建
- ❌ 跳过所有其他检查

**使用场景**：仅用于调试构建问题，不应用于正常开发流程

---

## 检查命令

### 统一检查入口

#### `npm run check`
**运行所有检查**（与 `prebuild` 相同）
- TypeScript 类型检查
- ESLint 检查
- 依赖架构检查
- Design Tokens 生成

**使用场景**：在提交代码前手动验证

### 单项检查命令

#### `npm run check:type`
**仅运行 TypeScript 类型检查**
```bash
tsc --noEmit
```

#### `npm run check:lint`
**仅运行 ESLint 检查**
```bash
eslint src --ext .ts,.tsx
```

#### `npm run check:arch` / `npm run check:deps`
**仅运行依赖架构检查**
```bash
dependency-cruiser --config .dependency-cruiser.cjs src
```

---

## 兼容性命令（向后兼容）

为了保持向后兼容，以下命令仍然可用，但它们现在指向新的统一命令：

- `npm run type-check` → `npm run check:type`
- `npm run lint` → `npm run check:lint`

---

## 开发工作流

### 日常开发

```bash
# 1. 开发时使用 watch 模式（不运行检查，快速反馈）
npm run dev

# 2. 提交前运行完整检查
npm run check

# 3. 构建前会自动运行检查（通过 prebuild hook）
npm run build
```

### CI/CD 流程

```bash
# 生产构建（自动包含所有检查）
npm run build:prod
```

### 快速迭代（不推荐，仅用于调试）

```bash
# 跳过检查的快速构建
npm run build:skip-checks
```

---

## 检查项说明

### 1. TypeScript 类型检查
- **命令**：`tsc --noEmit`
- **作用**：验证所有 TypeScript 代码的类型正确性
- **失败时**：修复类型错误后重试

### 2. ESLint 检查
- **命令**：`eslint src --ext .ts,.tsx`
- **作用**：检查代码风格和潜在问题
- **自动修复**：`npm run lint:fix`
- **失败时**：运行 `npm run lint:fix` 自动修复部分问题

### 3. 依赖架构检查
- **命令**：`dependency-cruiser --config .dependency-cruiser.cjs src`
- **作用**：验证代码依赖关系符合架构规范
- **失败时**：检查 `.dependency-cruiser.cjs` 配置，修复违规的依赖关系

### 4. Design Tokens 生成
- **命令**：`npm run generate:tokens`
- **作用**：生成最新的 CSS 变量文件
- **允许失败**：如果生成脚本未完全实现，不会阻止构建

---

## 脚本组织结构

```
构建工作流
├── check                    # 统一检查入口
│   ├── check:type          # TypeScript 检查
│   ├── check:lint          # ESLint 检查
│   └── check:arch          # 架构检查
├── build                    # 基础构建（自动运行 check）
├── build:dev               # 开发构建（自动运行 check）
├── build:prod              # 生产构建（自动运行 check + obfuscate）
└── build:skip-checks       # 跳过检查（不推荐）

兼容性命令
├── type-check              # → check:type
└── lint                    # → check:lint
```

---

## 常见问题

### Q: 为什么 `npm run build` 会自动运行检查？

**A**: 使用了 npm 的 `prebuild` hook。当运行 `npm run build` 时，npm 会自动先执行 `prebuild` 脚本（即 `npm run check`）。

### Q: 如何只运行构建而不运行检查？

**A**: 使用 `npm run build:skip-checks`，但**不推荐**用于正常开发流程。检查是为了确保代码质量。

### Q: 检查失败时如何快速修复？

**A**: 
- TypeScript 错误：查看错误信息，修复类型问题
- ESLint 错误：运行 `npm run lint:fix` 自动修复
- 架构检查错误：查看 dependency-cruiser 报告，修复依赖关系

### Q: 开发时每次都要等检查完成吗？

**A**: 不需要。开发时使用 `npm run dev`（watch 模式），它不会运行检查，提供快速反馈。只在提交代码或构建前运行 `npm run check`。

### Q: CI/CD 中应该使用哪个命令？

**A**: 使用 `npm run build:prod`，它会：
1. 运行所有检查（确保代码质量）
2. 执行构建
3. 代码混淆（生产优化）

---

## 最佳实践

1. **日常开发**：使用 `npm run dev`（watch 模式，快速反馈）
2. **提交前**：运行 `npm run check` 确保代码质量
3. **构建时**：直接运行 `npm run build`，检查会自动执行
4. **生产发布**：使用 `npm run build:prod`
5. **避免使用**：`npm run build:skip-checks`（除非调试构建问题）

---

## 相关文档

- [构建时架构检查说明](./构建时架构检查说明.md)
- [SDD + DX + Visual Regression 使用指南](./SDD-DX-Visual-Regression-使用指南.md)


